import * as $rjs_core from '../../runtime/core.js';import * as M0 from "./private/kw.rkt.js";import * as M1 from "../../runtime/paramz.rkt.js";import * as M2 from "../../runtime/kernel.rkt.js";import * as M3 from "./private/more-scheme.rkt.js";import * as M4 from "./private/promise.rkt.js";import * as M5 from "../../runtime/unsafe.rkt.js";var let_result2357 = M2.make_struct_type($rjs_core.Symbol.make("promise/name"),M4.struct_promise,0,0,false,M2.list(M2.cons(M4.prop_force,function(p3762) {return M5.unsafe_struct_ref(p3762,0)();})),M2.current_inspector(),false,$rjs_core.Pair.Empty,false,$rjs_core.Symbol.make("promise/name"));var struct_3757 = let_result2357.getAt(0);var make_3758 = let_result2357.getAt(1);var _p3759 = let_result2357.getAt(2);var _ref3760 = let_result2357.getAt(3);var _set_bang_3761 = let_result2357.getAt(4);var let_result2358 = M2.values(struct_3757,make_3758,_p3759);var struct_promise_by_name = let_result2358.getAt(0);var make_promise_by_name = let_result2358.getAt(1);var promise_by_name_p = let_result2358.getAt(2);var delay_by_name = make_promise_by_name;var let_result2359 = M2.make_struct_type($rjs_core.Symbol.make("promise/strict"),M4.struct_promise,0,0,false,M2.list(M2.cons(M4.prop_force,function(p3768) {return M4.reify_result(M5.unsafe_struct_ref(p3768,0));})),M2.current_inspector(),false,$rjs_core.Pair.Empty,false,$rjs_core.Symbol.make("promise/strict"));var struct_3763 = let_result2359.getAt(0);var make_3764 = let_result2359.getAt(1);var _p3765 = let_result2359.getAt(2);var _ref3766 = let_result2359.getAt(3);var _set_bang_3767 = let_result2359.getAt(4);var let_result2360 = M2.values(struct_3763,make_3764,_p3765);var struct_promise_by_strict = let_result2360.getAt(0);var make_promise_by_strict = let_result2360.getAt(1);var promise_by_strict_p = let_result2360.getAt(2);var delay_by_strict = function(thunk3769) {return make_promise_by_strict(M2.call_with_values(thunk3769,M2.list));};var let_result2361 = M2.make_struct_type($rjs_core.Symbol.make("running-thread"),M4.struct_running,1,0,false,M2.rnull,M2.current_inspector(),false,$rjs_core.Pair.makeList(0),false,$rjs_core.Symbol.make("running-thread"));var struct_3770 = let_result2361.getAt(0);var make_3771 = let_result2361.getAt(1);var _p3772 = let_result2361.getAt(2);var _ref3773 = let_result2361.getAt(3);var _set_bang_3774 = let_result2361.getAt(4);var let_result2362 = M2.values(struct_3770,make_3771,_p3772,M2.make_struct_field_accessor(_ref3773,0,$rjs_core.Symbol.make("thread")));var struct_running_thread = let_result2362.getAt(0);var make_running_thread = let_result2362.getAt(1);var running_thread_p = let_result2362.getAt(2);var running_thread_thread = let_result2362.getAt(3);var let_result2363 = M2.make_struct_type($rjs_core.Symbol.make("syncinfo"),false,4,0,false,M2.rnull,M2.current_inspector(),false,$rjs_core.Pair.makeList(1, 2, 3),false,$rjs_core.Symbol.make("syncinfo"));var struct_3775 = let_result2363.getAt(0);var make_3776 = let_result2363.getAt(1);var _p3777 = let_result2363.getAt(2);var _ref3778 = let_result2363.getAt(3);var _set_bang_3779 = let_result2363.getAt(4);var let_result2364 = M2.values(struct_3775,make_3776,_p3777,M2.make_struct_field_accessor(_ref3778,0,$rjs_core.Symbol.make("thunk")),M2.make_struct_field_accessor(_ref3778,1,$rjs_core.Symbol.make("done-evt")),M2.make_struct_field_accessor(_ref3778,2,$rjs_core.Symbol.make("done-sema")),M2.make_struct_field_accessor(_ref3778,3,$rjs_core.Symbol.make("access-sema")),M2.make_struct_field_mutator(_set_bang_3779,0,$rjs_core.Symbol.make("thunk")));var struct_syncinfo = let_result2364.getAt(0);var make_syncinfo = let_result2364.getAt(1);var syncinfo_p = let_result2364.getAt(2);var syncinfo_thunk = let_result2364.getAt(3);var syncinfo_done_evt = let_result2364.getAt(4);var syncinfo_done_sema = let_result2364.getAt(5);var syncinfo_access_sema = let_result2364.getAt(6);var set_syncinfo_thunk_bang_ = let_result2364.getAt(7);var let_result2371 = M2.make_struct_type($rjs_core.Symbol.make("promise/sync"),M4.struct_promise,0,0,false,M2.list(M2.cons(M2.prop_evt,function(p3785) {var v3786 = M5.unsafe_struct_ref(p3785,0);if (syncinfo_p(v3786)) {var if_res2370 = syncinfo_done_evt(v3786);} else {var if_res2370 = M2.always_evt;}return M2.wrap_evt(if_res2370,M2.rvoid);}),M2.cons(M4.prop_force,function(p3787) {var v3788 = M5.unsafe_struct_ref(p3787,0);if (M2.not(syncinfo_p(v3788))) {var if_res2369 = v3788;} else {if (running_thread_p(syncinfo_thunk(v3788))) {var r3789 = syncinfo_thunk(v3788);if (M2.eq_p(running_thread_thread(r3789),M2.current_thread())) {var if_res2366 = r3789();} else {M2.sync(syncinfo_done_evt(v3788));var if_res2366 = M5.unsafe_struct_ref(p3787,0);}var if_res2368 = if_res2366;} else {M2.call_with_semaphore(syncinfo_access_sema(v3788),function(p3790, v3791) {var thunk3792 = syncinfo_thunk(v3791);var done3793 = syncinfo_done_sema(v3791);if (running_thread_p(thunk3792)) {var if_res2367 = M2.rvoid();} else {set_syncinfo_thunk_bang_(v3791,make_running_thread(M2.object_name(thunk3792),M2.current_thread()));var if_res2367 = M3.call_with_exception_handler(function(e3794) {M5.__rjs_quoted__.unsafe_struct_set_bang_(p3790,0,M4.make_reraise(e3794));M2.semaphore_post(done3793);return e3794;},function() {M5.__rjs_quoted__.unsafe_struct_set_bang_(p3790,0,M2.call_with_values(thunk3792,M2.list));return M2.semaphore_post(done3793);});}return if_res2367;},false,p3787,v3788);var if_res2368 = M5.unsafe_struct_ref(p3787,0);}var if_res2369 = if_res2368;}return M4.reify_result(if_res2369);}),M2.cons(M2.prop_custom_write,function(p3795, port3796, write_p3797) {var v3798 = M5.unsafe_struct_ref(p3795,0);if (syncinfo_p(v3798)) {var if_res2365 = M4.make_promise(syncinfo_thunk(v3798));} else {var if_res2365 = p3795;}return M4.promise_printer(if_res2365,port3796,write_p3797);})),M2.current_inspector(),false,$rjs_core.Pair.Empty,false,$rjs_core.Symbol.make("promise/sync"));var struct_3780 = let_result2371.getAt(0);var make_3781 = let_result2371.getAt(1);var _p3782 = let_result2371.getAt(2);var _ref3783 = let_result2371.getAt(3);var _set_bang_3784 = let_result2371.getAt(4);var let_result2372 = M2.values(struct_3780,make_3781,_p3782);var struct_promise_by_sync = let_result2372.getAt(0);var make_promise_by_sync = let_result2372.getAt(1);var promise_by_sync_p = let_result2372.getAt(2);var delay_by_sync = function(thunk3799) {var done_sema3800 = M2.make_semaphore(0);return make_promise_by_sync(make_syncinfo(thunk3799,M2.semaphore_peek_evt(done_sema3800),done_sema3800,M2.make_semaphore(1)));};var let_result2377 = M2.make_struct_type($rjs_core.Symbol.make("promise/thread"),M4.struct_promise,0,0,false,M2.list(M2.cons(M2.prop_evt,function(p3806) {var v3807 = M5.unsafe_struct_ref(p3806,0);if (M4.running_p(v3807)) {var if_res2376 = running_thread_thread(v3807);} else {var if_res2376 = M2.always_evt;}return M2.wrap_evt(if_res2376,M2.rvoid);}),M2.cons(M4.prop_force,function(p3808) {var v3809 = M5.unsafe_struct_ref(p3808,0);if (running_thread_p(v3809)) {var t3810 = running_thread_thread(v3809);M2.thread_wait(t3810);var let_result2373 = M2.values();var v3811 = M5.unsafe_struct_ref(p3808,0);if (running_thread_p(v3811)) {var if_res2374 = M2.error($rjs_core.Symbol.make("force"),"promise's thread terminated ~a\n  promise: ~e","without result or exception",p3808);} else {var if_res2374 = v3811;}var if_res2375 = if_res2374;} else {var if_res2375 = v3809;}return M4.reify_result(if_res2375);})),M2.current_inspector(),false,$rjs_core.Pair.Empty,false,$rjs_core.Symbol.make("promise/thread"));var struct_3801 = let_result2377.getAt(0);var make_3802 = let_result2377.getAt(1);var _p3803 = let_result2377.getAt(2);var _ref3804 = let_result2377.getAt(3);var _set_bang_3805 = let_result2377.getAt(4);var let_result2378 = M2.values(struct_3801,make_3802,_p3803);var struct_promise_by_thread = let_result2378.getAt(0);var make_promise_by_thread = let_result2378.getAt(1);var promise_by_thread_p = let_result2378.getAt(2);var delay_by_thread = function(thunk3812, group3813) {var or_part3814 = M2.not(group3813);if (or_part3814) {var if_res2379 = or_part3814;} else {var if_res2379 = M2.thread_group_p(group3813);}if (if_res2379) {var if_res2380 = M2.rvoid();} else {var if_res2380 = M2.raise_argument_error($rjs_core.Symbol.make("delay/thread"),"(or/c thread-group? #f)",group3813);}if_res2380;var let_result2381 = M2.values();var initialized_sema3815 = M2.make_semaphore();var run3816 = function() {M2.semaphore_wait(initialized_sema3815);return M3.call_with_exception_handler(function(e3818) {M5.__rjs_quoted__.unsafe_struct_set_bang_(p3817,0,M4.make_reraise(e3818));return M2.kill_thread(M2.current_thread());},function() {return M5.__rjs_quoted__.unsafe_struct_set_bang_(p3817,0,M2.call_with_values(thunk3812,M2.list));});};var temp2387 = M2.object_name(thunk3812);if (group3813) {var __context2382 = $rjs_core.Marks.getFrames();var __context2383;try {__context2383 = $rjs_core.Marks.enterFrame();$rjs_core.Marks.setMark(M1.parameterization_key,M1.extend_parameterization(M2.continuation_mark_set_first(false,M1.parameterization_key),M2.current_thread_group,group3813));var __wcm_result2384 = M2.thread(run3816);} finally {$rjs_core.Marks.updateFrame(__context2382,__context2383);}var if_res2386 = __wcm_result2384;} else {var if_res2386 = M2.thread(run3816);}var p3817 = make_promise_by_thread(make_running_thread(temp2387,if_res2386));M2.semaphore_post(initialized_sema3815);return p3817;};var let_result2390 = M2.make_struct_type($rjs_core.Symbol.make("promise/idle"),struct_promise_by_thread,0,0,false,M2.list(M2.cons(M4.prop_force,function(p3824) {var v3825 = M5.unsafe_struct_ref(p3824,0);if (M2.procedure_p(v3825)) {if (running_thread_p(v3825)) {var if_res2388 = running_thread_thread(v3825);} else {var if_res2388 = v3825();}var controller3826 = if_res2388;M2.thread_send(controller3826,$rjs_core.Symbol.make("force!"));M2.thread_wait(controller3826);var if_res2389 = M5.unsafe_struct_ref(p3824,0);} else {var if_res2389 = v3825;}return M4.reify_result(if_res2389);})),M2.current_inspector(),false,$rjs_core.Pair.Empty,false,$rjs_core.Symbol.make("promise/idle"));var struct_3819 = let_result2390.getAt(0);var make_3820 = let_result2390.getAt(1);var _p3821 = let_result2390.getAt(2);var _ref3822 = let_result2390.getAt(3);var _set_bang_3823 = let_result2390.getAt(4);var let_result2391 = M2.values(struct_3819,make_3820,_p3821);var struct_promise_by_idle = let_result2391.getAt(0);var make_promise_by_idle = let_result2391.getAt(1);var promise_by_idle_p = let_result2391.getAt(2);var delay_by_idle = function(thunk3827, wait_for3828, work_while3829, tick3830, use_times_3831) {if (M2.evt_p(wait_for3828)) {var if_res2392 = M2.rvoid();} else {var if_res2392 = M2.raise_argument_error($rjs_core.Symbol.make("delay/idle"),"evt?",wait_for3828);}if_res2392;var let_result2393 = M2.values();if (M2.evt_p(work_while3829)) {var if_res2394 = M2.rvoid();} else {var if_res2394 = M2.raise_argument_error($rjs_core.Symbol.make("delay/idle"),"evt?",work_while3829);}if_res2394;var let_result2395 = M2.values();if (M2.real_p(tick3830)) {var if_res2396 = M2.not(M2.negative_p(tick3830));} else {var if_res2396 = false;}if (if_res2396) {var if_res2397 = M2.rvoid();} else {var if_res2397 = M2.raise_argument_error($rjs_core.Symbol.make("delay/idle"),"(>=/c 0.0)",tick3830);}if_res2397;var let_result2398 = M2.values();if (M2.real_p(use_times_3831)) {var if_res2399 = M2.rvoid();} else {var if_res2399 = M2.raise_argument_error($rjs_core.Symbol.make("delay/idle"),"real?",use_times_3831);}if_res2399;var let_result2400 = M2.values();if (M2._lt__eq_(use_times_3831,0)) {var if_res2402 = 0;} else {if (M2._gt__eq_(use_times_3831,1)) {var if_res2401 = 1;} else {var if_res2401 = use_times_3831;}var if_res2402 = if_res2401;}var use3832 = if_res2402;var work_time3833 = tick3830*use3832;var rest_time3834 = tick3830-work_time3833;var work3835 = function() {return M3.call_with_exception_handler(function(e3839) {M5.__rjs_quoted__.unsafe_struct_set_bang_(p3838,0,M4.make_reraise(e3839));return M2.kill_thread(M2.current_thread());},function() {return M5.__rjs_quoted__.unsafe_struct_set_bang_(p3838,0,M2.call_with_values(thunk3827,M2.list));});};var run3836 = function() {var force_evt3840 = M2.thread_receive_evt();M2.sync(wait_for3828,force_evt3840);var let_result2403 = M2.values();M5.__rjs_quoted__.unsafe_struct_set_bang_(p3838,0,make_running_thread(M2.object_name(thunk3827),controller_thread3837));var let_result2404 = M2.values();var __context2405 = $rjs_core.Marks.getFrames();var __context2406;try {__context2406 = $rjs_core.Marks.enterFrame();$rjs_core.Marks.setMark(M1.parameterization_key,M1.extend_parameterization(M2.continuation_mark_set_first(false,M1.parameterization_key),M2.current_thread_group,M2.make_thread_group()));var __wcm_result2407 = M2.thread(work3835);} finally {$rjs_core.Marks.updateFrame(__context2405,__context2406);}var worker3841 = __wcm_result2407;if (M2._gt__eq_(use3832,1)) {var if_res2409 = M2.equal_p(work_while3829,M2.always_evt);} else {var if_res2409 = false;}if (if_res2409) {var if_res2415 = M2.thread_wait(worker3841);} else {if (M2._lt__eq_(use3832,0)) {M2.thread_suspend(worker3841);M2.sync(force_evt3840);var if_res2414 = M2.thread_wait(worker3841);} else {M2.thread_suspend(worker3841);var loop3842 = function() {var or_part3843 = M2.sync_by_timeout(rest_time3834,force_evt3840);if (or_part3843) {var if_res2411 = or_part3843;} else {var if_res2411 = M2.sync(work_while3829,force_evt3840);}var begin_res2410 = if_res2411;M2.thread_resume(worker3841);if (M2.eq_p(begin_res2410,force_evt3840)) {var if_res2413 = M2.thread_wait(worker3841);} else {if (M2.sync_by_timeout(work_time3833,worker3841)) {var if_res2412 = M2.rvoid();} else {M2.thread_suspend(worker3841);var if_res2412 = loop3842();}var if_res2413 = if_res2412;}return if_res2413;};var if_res2414 = loop3842();}var if_res2415 = if_res2414;}return if_res2415;};var __context2416 = $rjs_core.Marks.getFrames();var __context2417;try {__context2417 = $rjs_core.Marks.enterFrame();$rjs_core.Marks.setMark(M1.parameterization_key,M1.extend_parameterization(M2.continuation_mark_set_first(false,M1.parameterization_key),M2.current_thread_group,M2.make_thread_group()));var __wcm_result2418 = M2.thread(run3836);} finally {$rjs_core.Marks.updateFrame(__context2416,__context2417);}var controller_thread3837 = __wcm_result2418;var or_part3844 = M2.object_name(thunk3827);if (or_part3844) {var if_res2420 = or_part3844;} else {var if_res2420 = $rjs_core.Symbol.make("idle-thread");}var p3838 = make_promise_by_idle(M0.new_procedure_rename(function() {return controller_thread3837;},if_res2420));return p3838;};var __rjs_quoted__ = {};__rjs_quoted__.make_syncinfo = make_syncinfo;__rjs_quoted__.struct_promise_by_sync = struct_promise_by_sync;__rjs_quoted__.make_promise_by_idle = make_promise_by_idle;__rjs_quoted__.syncinfo_thunk = syncinfo_thunk;__rjs_quoted__.syncinfo_done_sema = syncinfo_done_sema;__rjs_quoted__.promise_by_strict_p = promise_by_strict_p;__rjs_quoted__.promise_by_thread_p = promise_by_thread_p;__rjs_quoted__.promise_by_name_p = promise_by_name_p;__rjs_quoted__.promise_by_sync_p = promise_by_sync_p;__rjs_quoted__.running_thread_thread = running_thread_thread;__rjs_quoted__.delay_by_thread = delay_by_thread;__rjs_quoted__.running_thread_p = running_thread_p;__rjs_quoted__.struct_promise_by_thread = struct_promise_by_thread;__rjs_quoted__.struct_syncinfo = struct_syncinfo;__rjs_quoted__.syncinfo_done_evt = syncinfo_done_evt;__rjs_quoted__.struct_promise_by_strict = struct_promise_by_strict;__rjs_quoted__.make_promise_by_sync = make_promise_by_sync;__rjs_quoted__.delay_by_sync = delay_by_sync;__rjs_quoted__.make_running_thread = make_running_thread;__rjs_quoted__.struct_promise_by_name = struct_promise_by_name;__rjs_quoted__.delay_by_idle = delay_by_idle;__rjs_quoted__.syncinfo_p = syncinfo_p;__rjs_quoted__.make_promise_by_name = make_promise_by_name;__rjs_quoted__.struct_running_thread = struct_running_thread;__rjs_quoted__.syncinfo_access_sema = syncinfo_access_sema;__rjs_quoted__.struct_promise_by_idle = struct_promise_by_idle;__rjs_quoted__.make_promise_by_thread = make_promise_by_thread;__rjs_quoted__.promise_by_idle_p = promise_by_idle_p;__rjs_quoted__.make_promise_by_strict = make_promise_by_strict;__rjs_quoted__.delay_by_name = delay_by_name;__rjs_quoted__.delay_by_strict = delay_by_strict;__rjs_quoted__.set_syncinfo_thunk_bang_ = set_syncinfo_thunk_bang_;export { __rjs_quoted__,promise_by_name_p };